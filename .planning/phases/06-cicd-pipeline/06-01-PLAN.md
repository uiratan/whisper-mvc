---
phase: 06-cicd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
autonomous: false
user_setup:
  - service: fly.io
    why: "Automated deployment from GitHub Actions"
    env_vars:
      - name: FLY_API_TOKEN
        source: "Run `flyctl auth token` locally, then store as GitHub secret"
    dashboard_config:
      - task: "Verify app exists"
        location: "https://fly.io/dashboard - app whisper-test should be listed"

must_haves:
  truths:
    - "Creating a git tag triggers automatic deployment to Fly.io"
    - "Pipeline verifies app health after deployment completes"
    - "GitHub shows deploy success/failure status for each tag"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "GitHub Actions workflow for tag-triggered deploys"
      min_lines: 40
      contains: "on: push: tags:"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "fly.io API"
      via: "flyctl deploy action"
      pattern: "superfly/flyctl-actions/setup-flyctl"
    - from: ".github/workflows/deploy.yml"
      to: "fly.toml"
      via: "deployment configuration"
      pattern: "flyctl deploy"
---

<objective>
Create automated deployment pipeline from GitHub tags to Fly.io with health verification.

Purpose: Enable controlled production deployments via git tags (e.g., `v2.1.0`) with automatic health checks and status reporting.

Output: Working GitHub Actions workflow that deploys on tag creation, verifies deployment, and reports status.
</objective>

<execution_context>
@/home/uira/.claude/get-shit-done/workflows/execute-plan.md
@/home/uira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@fly.toml
@Dockerfile
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for tag-triggered deploys</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create GitHub Actions workflow that:

1. **Triggers on tag push** matching pattern `v*` (e.g., v2.1.0, v2.1.1)
2. **Uses official Fly.io action** (`superfly/flyctl-actions/setup-flyctl@master`)
3. **Deploys using flyctl** with existing fly.toml and Dockerfile
4. **Verifies deployment health** by:
   - Waiting 30 seconds for app to stabilize
   - Running `flyctl status` to check app is running
   - Curling health endpoint `https://whisper-test.fly.dev/` expecting 200 status
5. **Reports status** via GitHub's built-in workflow status (no additional notifications needed)

Workflow structure:
- Name: "Deploy to Fly.io"
- Trigger: `on.push.tags: ['v*']`
- Job: single job named `deploy`
- Runs on: `ubuntu-latest`
- Steps:
  1. Checkout code
  2. Setup flyctl (uses FLY_API_TOKEN secret)
  3. Deploy: `flyctl deploy --remote-only`
  4. Wait: `sleep 30`
  5. Verify status: `flyctl status -a whisper-test`
  6. Health check: `curl -f https://whisper-test.fly.dev/`

Use `--remote-only` flag to build on Fly.io builders (not GitHub runner) since Dockerfile is multi-stage and heavy.

Secret `FLY_API_TOKEN` will be configured in next task.
  </action>
  <verify>
```bash
cat .github/workflows/deploy.yml
# Verify contains: on.push.tags, flyctl deploy, health check curl
```
  </verify>
  <done>
GitHub Actions workflow file exists with tag trigger, Fly.io deployment step, and health verification.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Fly.io API token as GitHub secret</name>
  <action>Configure Fly.io API token as GitHub secret</action>
  <instructions>
The GitHub Actions workflow requires a `FLY_API_TOKEN` secret to authenticate with Fly.io.

**Steps to configure:**

1. **Get Fly.io API token**
   ```bash
   flyctl auth token
   ```
   Copy the token output (starts with `fo1_...`)

2. **Add token to GitHub secrets**

   Option A - Using GitHub CLI (if installed):
   ```bash
   gh secret set FLY_API_TOKEN
   # Paste token when prompted
   ```

   Option B - Using GitHub web UI:
   - Go to: https://github.com/[your-username]/whisper-test/settings/secrets/actions
   - Click "New repository secret"
   - Name: `FLY_API_TOKEN`
   - Value: [paste token from step 1]
   - Click "Add secret"

3. **Verify secret exists**
   ```bash
   gh secret list
   # Should show FLY_API_TOKEN
   ```

**If you don't have flyctl installed:**
- Install: `curl -L https://fly.io/install.sh | sh`
- Login: `flyctl auth login`
- Then run `flyctl auth token`
  </instructions>
  <resume-signal>Type "configured" when FLY_API_TOKEN secret is set in GitHub</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end pipeline execution</name>
  <what-built>Complete CI/CD pipeline (workflow + secret configuration)</what-built>
  <how-to-verify>
**Test the pipeline end-to-end:**

1. **Create a test tag locally**
   ```bash
   git tag v2.1.0-test
   git push origin v2.1.0-test
   ```

2. **Watch GitHub Actions**
   - Visit: https://github.com/[your-username]/whisper-test/actions
   - You should see a new workflow run for "Deploy to Fly.io"
   - Click on the run to see logs

3. **Expected behavior:**
   - ✓ Checkout step succeeds
   - ✓ Setup flyctl step succeeds
   - ✓ Deploy step succeeds (takes 3-5 minutes due to Docker build)
   - ✓ Health check step succeeds (app responds with 200)
   - ✓ Overall workflow status: green checkmark

4. **Verify deployment**
   ```bash
   flyctl status -a whisper-test
   # Should show app running
   ```

   Visit: https://whisper-test.fly.dev/
   - App should load and be functional

5. **Check GitHub commit status**
   - Tag `v2.1.0-test` on GitHub should show green checkmark
   - Indicates successful deployment

**If deployment fails:**
- Check workflow logs for errors
- Common issues:
  - FLY_API_TOKEN not set or invalid → reconfigure secret
  - Dockerfile build error → check Docker build locally first
  - Health check timeout → app might need more than 30s, increase sleep time
  </how-to-verify>
  <resume-signal>Type "approved" if pipeline works, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/deploy.yml` exists with correct trigger and steps
2. `FLY_API_TOKEN` secret configured in GitHub repository settings
3. Test tag triggers workflow run
4. Workflow deploys to Fly.io successfully
5. Health check passes (app responds to HTTP request)
6. GitHub shows deployment status on tag
</verification>

<success_criteria>
- [ ] Creating a git tag matching `v*` pattern triggers GitHub Actions workflow
- [ ] Workflow deploys to Fly.io using existing fly.toml and Dockerfile
- [ ] Workflow verifies app health via `flyctl status` and HTTP health check
- [ ] GitHub displays deployment success/failure status for each tag
- [ ] Test deployment completes successfully end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/06-cicd-pipeline/06-01-SUMMARY.md` documenting:
- Workflow structure and trigger pattern
- Deployment steps and health verification approach
- How to create releases (tag creation process)
- Any issues encountered during first deployment
</output>
