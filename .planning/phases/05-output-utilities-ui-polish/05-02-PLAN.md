---
phase: 05-output-utilities-ui-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/TranscriptionPlayer.tsx
  - src/components/AudioUploader.tsx
autonomous: true

must_haves:
  truths:
    - "User can click on any segment timestamp to seek audio to that time"
    - "User can click on text in full text block to seek to corresponding segment"
    - "Currently playing segment is visually highlighted in real-time"
    - "Audio player has standard controls (play, pause, seek, volume)"
    - "Status messages clearly indicate upload vs transcription phases"
  artifacts:
    - path: "src/components/TranscriptionPlayer.tsx"
      provides: "Audio player component with playback tracking"
      min_lines: 50
      exports: ["default"]
    - path: "src/components/AudioUploader.tsx"
      provides: "Integration of player with interactive segments"
      contains: "currentTime|onTimeUpdate|onClick.*seek"
  key_links:
    - from: "Segment onClick handler"
      to: "audio.currentTime setter"
      via: "seek to timestamp"
      pattern: "audioRef\\.current\\.currentTime\\s*="
    - from: "audio onTimeUpdate event"
      to: "activeSegmentIndex state"
      via: "track current segment"
      pattern: "onTimeUpdate.*setActiveSegment"
---

<objective>
Enable interactive playback with bidirectional audio-text synchronization and enhanced status feedback.

Purpose: Fulfill UIUX-01 (Enhanced status feedback) and UIUX-02 (Segment interaction) by adding an audio player that syncs with the transcription, allowing click-to-seek and real-time highlight of the currently spoken segment.

Output: Audio player component and interactive transcription display where clicking text seeks audio and playback highlights the active segment, plus clearer status messaging for upload/transcription phases.
</objective>

<execution_context>
@/home/uira/.claude/get-shit-done/workflows/execute-plan.md
@/home/uira/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-output-utilities-ui-polish/05-CONTEXT.md
@src/components/AudioUploader.tsx
@src/components/RecordingPreview.tsx
</context>

<tasks>

<task type="auto">
  <name>Create audio player component with playback tracking</name>
  <files>src/components/TranscriptionPlayer.tsx</files>
  <action>
Create a new React component for audio playback with time tracking:

1. **Component signature**:
   ```tsx
   interface TranscriptionPlayerProps {
     audioUrl: string
     onTimeUpdate?: (currentTime: number) => void
     seekToTime?: number  // External seek control
   }
   ```

2. **Implementation details**:
   - Use native HTML5 `<audio>` element with controls
   - Ref to access audio DOM element: `const audioRef = useRef<HTMLAudioElement>(null)`
   - Handle `onTimeUpdate` event: call props.onTimeUpdate with currentTime
   - useEffect to handle external seeking: when `seekToTime` prop changes, set `audioRef.current.currentTime = seekToTime`
   - Audio controls: show browser default controls (controls attribute)
   - Styling: Full width, Tailwind rounded borders matching app theme

3. **Edge cases**:
   - Guard ref.current null checks before accessing currentTime
   - Only seek if seekToTime is a valid number and audio is loaded
   - Clean up: no special cleanup needed (native audio element)

4. **Layout**: Wrapped in a rounded container with padding, matching RecordingPreview.tsx styling patterns (bg-gray-50, border, rounded-lg).

5. **TypeScript**: Proper types for all props and refs, 'use client' directive at top.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation.
Check that component renders an audio element with controls.
  </verify>
  <done>
TranscriptionPlayer.tsx exists, exports default component, accepts audioUrl/onTimeUpdate/seekToTime props, renders HTML5 audio with controls, and passes TypeScript checking.
  </done>
</task>

<task type="auto">
  <name>Integrate player and implement bidirectional sync</name>
  <files>src/components/AudioUploader.tsx</files>
  <action>
Modify AudioUploader to add interactive playback with text-audio synchronization:

1. **Import player**: `import TranscriptionPlayer from './TranscriptionPlayer'`

2. **Add state for playback tracking**:
   - `const [audioUrl, setAudioUrl] = useState<string | null>(null)` - URL of uploaded/transcribed audio
   - `const [currentPlaybackTime, setCurrentPlaybackTime] = useState<number>(0)` - current audio position
   - `const [seekToTime, setSeekToTime] = useState<number | undefined>(undefined)` - trigger seeking
   - `const [activeSegmentIndex, setActiveSegmentIndex] = useState<number | null>(null)` - which segment is playing

3. **Store audio URL after transcription**: In the xhr 'load' handler (around line 142), after setting transcription, also set audioUrl:
   - Extract from response.filePath or construct from response.fileName
   - Pattern: `/uploads/${response.fileName}` (assuming uploads are served statically)
   - Set: `setAudioUrl('/uploads/' + response.fileName)` if response has fileName

4. **Implement seek handler**:
   ```tsx
   const handleSeekToTimestamp = (seconds: number) => {
     setSeekToTime(seconds)
     // Reset seekToTime after applying to allow re-seeking to same time
     setTimeout(() => setSeekToTime(undefined), 100)
   }
   ```

5. **Implement active segment tracking**: When player reports time update:
   ```tsx
   const handleTimeUpdate = (currentTime: number) => {
     setCurrentPlaybackTime(currentTime)
     // Find which segment is currently playing
     const index = transcription.segments.findIndex(
       seg => currentTime >= seg.start && currentTime < seg.end
     )
     setActiveSegmentIndex(index >= 0 ? index : null)
   }
   ```

6. **Add player to results section**: After the "Transcription" heading and action buttons (if 05-01 ran) or right before Full Text:
   ```tsx
   {audioUrl && (
     <div className="mb-6">
       <TranscriptionPlayer
         audioUrl={audioUrl}
         onTimeUpdate={handleTimeUpdate}
         seekToTime={seekToTime}
       />
     </div>
   )}
   ```

7. **Make Full Text interactive**: Wrap text in clickable spans for each segment:
   - Instead of `<p>{transcription.text}</p>`, map over segments
   - Each segment text becomes: `<span onClick={() => handleSeekToTimestamp(segment.start)} className="cursor-pointer hover:bg-indigo-100 transition-colors">{segment.text}</span>`
   - Active segment gets additional class: `bg-indigo-200 font-medium`
   - Use `activeSegmentIndex` to determine which span is active

8. **Make segment list interactive**: Add onClick to existing segment divs (around line 482):
   - Add: `onClick={() => handleSeekToTimestamp(segment.start)}` to the segment container div
   - Update className to include: `cursor-pointer` and conditional highlighting
   - If segment index matches `activeSegmentIndex`, add: `bg-indigo-100 border-indigo-400` (replace hover state when active)

9. **Enhance status messages** per UIUX-01:
   - Line 122 "Uploading..." - already clear
   - Add after upload completes but before transcription: "Converting to WAV..." (if you can detect this phase from backend)
   - Add when transcription starts: "Transcribing audio..." (update status message)
   - Current implementation shows generic "Upload successful!" - keep as-is since backend does all processing in one call

10. **Polish segment typography** per user decision:
    - Increase segment text contrast: use `text-gray-900` instead of `text-gray-800`
    - Improve timestamp readability: use `text-indigo-700` and `font-semibold` for timestamps
    - Add subtle shadow on hover: `hover:shadow-sm`

11. **Clean up on new upload**: Reset playback state when user starts a new upload or recording:
    - In handleUpload (before upload starts), add: `setAudioUrl(null); setActiveSegmentIndex(null); setCurrentPlaybackTime(0)`
    - In handleClear, add the same resets
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation.
Verify audio player appears in results section after transcription.
Test clicking segment timestamps to confirm seeking works.
Test that active segment highlights during playback.
Check that segment styling has improved contrast and hover states.
  </verify>
  <done>
Audio player displays in results. Clicking timestamps in segment list seeks audio. Clicking text in Full Text block seeks audio. Currently playing segment is highlighted with bg-indigo-100/200. Segment typography has better contrast (text-gray-900, indigo-700 timestamps). TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `npx tsc --noEmit`
2. Audio player renders below transcription heading
3. Clicking segment timestamp seeks audio to that time
4. Clicking text in "Full Text" block seeks audio to corresponding segment
5. Currently playing segment highlights in real-time (both in list and full text)
6. Segment styling has improved contrast and typography
7. Hover states work on interactive segments
8. Playback state resets when starting new upload/recording
</verification>

<success_criteria>
- [ ] Audio player appears in transcription results section with standard controls
- [ ] Clicking timestamp in segment list seeks audio to that exact time
- [ ] Clicking text in "Full Text" block seeks audio to corresponding segment
- [ ] Currently playing segment is highlighted with indigo background
- [ ] Highlight updates in real-time as audio plays through segments
- [ ] Both segment list and full text block support click-to-seek
- [ ] Segments have improved typography (higher contrast, semibold timestamps)
- [ ] Hover effects provide clear interaction feedback
- [ ] Status messages clearly differentiate upload vs transcription phases
</success_criteria>

<output>
After completion, create `.planning/phases/05-output-utilities-ui-polish/05-02-SUMMARY.md`
</output>
