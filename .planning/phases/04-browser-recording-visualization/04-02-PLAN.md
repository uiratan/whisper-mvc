---
phase: 04-browser-recording-visualization
plan: 02
type: execute
wave: 1
depends_on: ["04-01-PLAN.md"]
files_modified:
  - package.json
  - src/components/AudioUploader.tsx
  - src/components/LiveVisualizer.tsx
  - src/components/RecordingPreview.tsx
autonomous: true

must_haves:
  truths:
    - "Real-time waveform visualization is shown during recording"
    - "Waveform-based preview player is shown after stopping"
    - "Full playback controls (play/pause, speed, volume) are implemented"
  artifacts:
    - path: "src/components/LiveVisualizer.tsx"
      provides: "Real-time canvas-based waveform"
    - path: "src/components/RecordingPreview.tsx"
      provides: "WaveSurfer-based preview player"
---

<objective>
Implement the visual components for real-time feedback and recording review.

Purpose: Provide visual confirmation of audio capture and a high-quality review experience.
Output: LiveVisualizer and RecordingPreview components integrated into the main UI.
</objective>

<execution_context>
@/home/uira/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-browser-recording-visualization/04-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Install visualization dependencies</name>
  <files>
    package.json
  </files>
  <action>
Install `wavesurfer.js` and `@wavesurfer/react`.
```bash
npm install wavesurfer.js @wavesurfer/react
```
  </action>
  <verify>
Check package.json for the new dependencies.
  </verify>
  <done>
- wavesurfer dependencies installed
  </done>
</task>

<task type="auto">
  <name>Implement LiveVisualizer component</name>
  <files>
    src/components/LiveVisualizer.tsx
  </files>
  <action>
Create a `LiveVisualizer` component that:
1. Takes a `MediaStream` as a prop.
2. Uses the Web Audio API (`AudioContext`, `AnalyserNode`) to analyze the stream.
3. Draws a real-time waveform on an HTML5 `<canvas>` using `requestAnimationFrame`.
4. Cleans up the AudioContext and animation frame on unmount.
  </action>
  <verify>
Ensure the canvas draws moving lines/bars when the microphone picks up sound.
  </verify>
  <done>
- LiveVisualizer implemented with Canvas and AnalyserNode
- Correct cleanup of audio resources
  </done>
</task>

<task type="auto">
  <name>Implement RecordingPreview component</name>
  <files>
    src/components/RecordingPreview.tsx
  </files>
  <action>
Create a `RecordingPreview` component that:
1. Takes the `audioUrl` (from useVoiceRecorder) as a prop.
2. Uses `@wavesurfer/react` to render a waveform of the recorded audio.
3. Implements full playback controls as per 04-CONTEXT.md:
   - Play/Pause toggle.
   - Seek via waveform click.
   - Volume slider.
   - Playback speed selector (0.5x, 1x, 1.5x, 2x).
  </action>
  <verify>
Verify that the waveform loads the recording and all controls work as expected.
  </verify>
  <done>
- RecordingPreview implemented with WaveSurfer
- All required controls (Play, Speed, Volume, Seek) functional
  </done>
</task>

<task type="auto">
  <name>Final UI Integration in AudioUploader</name>
  <files>
    src/components/AudioUploader.tsx
  </files>
  <action>
Update `AudioUploader.tsx` to:
1. Show `LiveVisualizer` during the active recording state.
2. Show `RecordingPreview` when a recording is stopped and in the preview state.
3. Show the "Confirm/Upload" button only in the preview state.
4. Add the timer display (formatted MM:SS) next to the visualizer.
5. Implement the "Simple Transition" logic (Live Visualizer is replaced by Preview Player).
  </action>
  <verify>
End-to-end manual test:
- Start recording -> Waveform animates + Timer runs.
- Stop recording -> Live waveform disappears, Preview waveform appears with controls.
- Play preview, change speed, seek.
- Click "Upload" -> File is processed by the existing backend flow.
  </verify>
  <done>
- Components integrated into the main UI
- Timer implemented and accurate
- Smooth transitions between states
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Recording shows real-time waveform and timer.
2. Stopped recording shows an interactive waveform player.
3. All player controls (speed, volume, seek) are functional.
4. "Discard" and "Redo" buttons work as expected in the UI.
5. Confirmed recording is uploaded and transcribed correctly.
</verification>

<success_criteria>
- Real-time visualization is smooth and responsive.
- Preview player meets all requirements from 04-CONTEXT.md.
- UI transitions are clean and intuitive.
</success_criteria>

<output>
After completion, Phase 04 is finished.
</output>
